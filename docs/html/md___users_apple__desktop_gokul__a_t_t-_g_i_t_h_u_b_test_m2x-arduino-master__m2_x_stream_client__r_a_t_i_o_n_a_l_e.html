<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: RATIONALE</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md___users_apple__desktop_gokul__a_t_t-_g_i_t_h_u_b_test_m2x-arduino-master__m2_x_stream_client__r_a_t_i_o_n_a_l_e.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">RATIONALE </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>As of version 2.2.0, we've change the library structure of this library to a header-only implementation. So as of now, all the M2X library implementation will be in <code><a class="el" href="_m2_x_stream_client_8h.html">M2XStreamClient/M2XStreamClient.h</a></code> file. For each platform, this header file might include one more addtional platform specific header file, the naming of this file follows <code>m2x-&lt;platform&gt;.h</code> convention. So for Arduino, this is <code><a class="el" href="m2x-arduino_8h.html">m2x-arduino.h</a></code>, for ESP8266, this is <code><a class="el" href="m2x-esp8266_8h.html">m2x-esp8266.h</a></code>.</p>
<p>We will provide a little rationale on how we decide to make this change.</p>
<h4>I thought using headers for declarations, and sources for implementations is good practice for C/C++ programming?</h4>
<p>This might (or might not) be true if you have a large codebase for a sophisticated application. However, for a library, one thing we cannot ignore is build system. One application might use <a href="https://www.gnu.org/software/make/">Make</a>, another might use <a href="https://cmake.org/">CMake</a>, yet another one might use <a href="http://www.scons.org/">SCons</a>, <a href="http://bazel.io/">Bazel</a> or even <a href="http://nethack4.org/projects/aimake/">home-grown build systems</a>. To make things worse, each embedded system might have its own stack: Arduino has <a href="https://www.arduino.cc/en/Hacking/LibraryTutorial">one</a>, mbed has <a href="https://developer.mbed.org/compiler/">one</a>, and Cypress also has <a href="http://www.cypress.com/products/psoc-creator">one</a>!</p>
<p>This is slowly becoming a nightmare for us since we are planning to support all those boards with one library and one set of APIs. We have a common codebase, which is the current one. Due to the limitations of each platform, we have to create <a href="https://github.com/attm2x/m2x-launchpad-energia">many</a> <a href="https://github.com/attm2x/m2x-galileo">many</a> <a href="https://github.com/attm2x/m2x-cypress-psoc">different</a> <a href="https://github.com/attm2x/m2x-arm-mbed">repo</a> for each platform here. The underlying code only differs in very small part of the code, hence we have to maintain all of them at once.</p>
<p>We do have a fresh rewrite of the Arduino library going on internally, this is not ready for release yet since we are still polishing the API, so we start to wonder: is there anything we can do with the current codebase?</p>
<p>Of course! There's something called <a href="http://buffered.io/posts/the-magic-of-unity-builds/">Unity</a> <a href="http://engineering-game-dev.com/2009/12/15/the-evils-of-unity-builds/">Build</a> <a href="https://cheind.wordpress.com/2009/12/10/reducing-compilation-time-unity-builds/">exists</a> in the C/C++ community. The trick here is use <code>#include</code> to combine multiple <code>.h</code> or even <code>.c</code> or <code>.cpp</code> file into a single file, so compiling the single file is enough for building the project. Since this avoids recomplication brought by including the same header multiple times, some argue that this might bringing performance boosts as well as architectural benefits.</p>
<p>While this is <a href="http://number-none.com/blow/john_carmack_on_inlined_code.html">supported</a> by some very famous name in the C++ community, some other people have questions on this, since it ruins the possibility of parallel compiling: with one single source code, you can only compile it with one core, which might contain more disadvantages.</p>
<p>However, while we are not aiming for the same performance benefits, we can introduce this technique to this library for the architectural benefits! We can shrink our library to a single file so it can be trivial to include it in any build system!</p>
<h4>Okay I get Unity Build, but it does not explain why you are only using header files!</h4>
<p>Well, Unity Build normally talks about compiling applications, not libraries. With an application, we will inevitably have a source code, we cannot avoid this, so Unity Build just advocates using one source file. However, for libraries, having source file means you have to include it in the host build system, while using a header file, all we need is a <code>#include</code> line, we don't need to do anything at the build system level(well, actually we have to, but the point is: we've already shrink our build system integration to the minimum).</p>
<p>Besides that, there's also a practical reason at Arduino side:</p>
<p>Remember that in Arduino, the actual user can only write source code in a single <code>.ino</code> file? With the previous version of this library, we cannot do something like:</p>
<div class="fragment"><div class="line">#define DEBUG</div><div class="line">#include &lt;M2XStreamClient.h&gt;</div></div><!-- fragment --><p>This is because the <code>.cpp</code> file in our library cannot pick up the <code>DEBUG</code> macro. Hence to debug the library, we have to manually navigate to the M2X client library, change the header file to add the <code>DEBUG</code> macro, then re-compile everything. This is very cumbersome, and it's hard to remember to change the macro back once you've done with debugging. With a single header file, we can simply define the <code>DEBUG</code> macro in the <code>.ino</code> file, which saves a whole lot of hassles.</p>
<p>In fact, we take this technique one step further: we also let the user specify what board platform he / she is using now! So the user would actually use:</p>
<div class="fragment"><div class="line">#define ARDUINO_PLATFORM</div><div class="line">#include &lt;M2XStreamClient.h&gt;</div></div><!-- fragment --><p>To define that he / she is now using Arduino boards. This way we can provide supports for many different boards within one single library. The maintainence hassle can also be avoided. If someone is contributing to this library, we don't have to manually port the same changes to many different libraries.</p>
<h4>Ahhh, I don't want to specify the platform to use every time I'm writing some code, can't you just auto-detect this?</h4>
<p>Of course! We do have this in mind. In the future we will definitely add auto-detection code so if you don't specify the platform to use, we can detect them for you. However, since there're many embedded development environments, and new environments are coming out everyday, we do want to make sure we are careful with this feature, since it might be worse to detect the platform wrong than not detecting at all.</p>
<p>And even if we have auto-detection in place, we will also support manual overrides, so if you do provide a platform definition at the top of the <code>#include</code> line, we will use your specified one and disable auto-detection.</p>
<h4>Don't you know something called <a href="https://www.sqlite.org/amalgamation.html">amalgamation</a> exists?</h4>
<p>Yes we do? However, since our library is quite short, we don't believe introducing amalgamation is necessary. This might be helpful for something as big as SQLite, but for our simple library that only has around 1200 lines of code, we want to keep it simple here. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
